<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot V22.0 - Phi√™n B·∫£n ·ªîn ƒê·ªãnh</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; display: flex; flex-direction: column; height: 100vh; }
        .header { background-color: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .header button { background-color: #dc3545; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; line-height: 1.4; }
        .bot { background-color: #e9ecef; align-self: flex-start; border-bottom-left-radius: 2px; }
        .user { background-color: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        #input-area { padding: 10px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        #user-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        #send-btn { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .error-msg { background-color: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    </style>
</head>
<body>

<div class="header">
    ü§ñ Chatbot AI
    <button onclick="resetChat()">X√≥a L·ªãch S·ª≠</button>
</div>

<div id="chat-window"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="Nh·∫≠p tin nh·∫Øn (!HOC, !DANHGON)...">
    <button id="send-btn" onclick="sendMessage()">G·ª≠i</button>
</div>

<script>
    let knowledge = {};

    // 1. T·∫£i ki·∫øn th·ª©c t·ª´ file knowledge.json
    async function loadKnowledge() {
        try {
            const response = await fetch('knowledge.json');
            if (!response.ok) throw new Error("Kh√¥ng t√¨m th·∫•y file");
            const data = await response.json();
            knowledge = { ...knowledge, ...data };
            console.log("ƒê√£ t·∫£i knowledge.json");
        } catch (error) {
            appendMessage(`‚ö†Ô∏è **L∆∞u √Ω:** Kh√¥ng t·∫£i ƒë∆∞·ª£c file 'knowledge.json'. Chatbot s·∫Ω d√πng ki·∫øn th·ª©c b·∫°n d·∫°y th·ªß c√¥ng.`, 'bot error-msg');
        }
    }

    // 2. T·∫£i ki·∫øn th·ª©c ƒë√£ d·∫°y (Local Storage)
    function loadMemory() {
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (!key.startsWith('chat_history')) {
                knowledge[key] = localStorage.getItem(key);
            }
        }
    }

    // 3. Giao di·ªán Chat
    const chatWindow = document.getElementById('chat-window');
    
    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        // X·ª≠ l√Ω xu·ªëng d√≤ng v√† in ƒë·∫≠m c∆° b·∫£n
        div.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // 4. X·ª≠ l√Ω L·ªánh
    async function handleCommand(input) {
        const upperInput = input.toUpperCase();

        // L·ªánh !DANHGON (S·ª≠ d·ª•ng API M·ªõi ·ªïn ƒë·ªãnh h∆°n)
        if (upperInput === '!DANHGON') {
            appendMessage("‚è≥ ƒêang t·∫£i danh ng√¥n t·ª´ Internet...", 'bot');
            try {
                const res = await fetch('https://dummyjson.com/quotes/random'); // API M·ªõi, ·ªïn ƒë·ªãnh
                const data = await res.json();
                const quoteText = data.quote; 
                const author = data.author; 
                appendMessage(`üí° **Danh ng√¥n:**\n"${quoteText}"\n‚Äî *${author}*`, 'bot');
            } catch (e) {
                appendMessage(`‚ùå L·ªói k·∫øt n·ªëi: ${e.message}`, 'bot error-msg');
            }
            return true;
        }

        // L·ªánh !HOC
        if (upperInput.startsWith('!HOC')) {
            const parts = input.substring(4).split('=');
            if (parts.length < 2) {
                appendMessage("‚ö†Ô∏è Sai c√∫ ph√°p. D√πng: !HOC C√¢u h·ªèi = C√¢u tr·∫£ l·ªùi", 'bot');
                return true;
            }
            const key = parts[0].trim().toLowerCase();
            const value = parts[1].trim();
            localStorage.setItem(key, value); // L∆∞u vƒ©nh vi·ªÖn
            knowledge[key] = value;
            appendMessage(`‚úÖ ƒê√£ h·ªçc: **"${key}"**`, 'bot');
            return true;
        }

        // L·ªánh !JOKE (K·ªÉ chuy·ªán c∆∞·ªùi)
        if (upperInput === '!JOKE') {
            appendMessage(`‚è≥ ƒêang t√¨m ki·∫øm chuy·ªán c∆∞·ªùi...`, 'bot');
            try {
                const response = await fetch('https://api.chucknorris.io/jokes/random');
                const data = await response.json();
                const jokeText = data.value; 
                appendMessage(`üòÇ **CHUY·ªÜN C∆Ø·ªúI:**\n${jokeText}`, 'bot');
            } catch (error) {
                appendMessage(`**‚ö†Ô∏è L·ªñI K·∫æT N·ªêI:** Kh√¥ng th·ªÉ k·ªÉ chuy·ªán c∆∞·ªùi. (L·ªói: ${error.message})`, 'bot');
            }
            return true;
        }

        return false; // Kh√¥ng ph·∫£i l·ªánh
    }

    // 5. X·ª≠ l√Ω Tin nh·∫Øn
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const text = inputField.value.trim();
        if (!text) return;

        appendMessage(text, 'user');
        inputField.value = '';

        // Ki·ªÉm tra xem c√≥ ph·∫£i l·ªánh kh√¥ng
        const isCommand = await handleCommand(text);
        if (isCommand) return;

        // T√¨m ki·∫øm c√¢u tr·∫£ l·ªùi
        const key = text.toLowerCase();
        if (knowledge[key]) {
            setTimeout(() => appendMessage(knowledge[key], 'bot'), 500);
        } else {
            // T√¨m ki·∫øm linh ho·∫°t (n·∫øu ch·ª©a t·ª´ kh√≥a)
            const found = Object.keys(knowledge).find(k => key.includes(k) || k.includes(key));
            if (found && knowledge[found]) {
                setTimeout(() => appendMessage(knowledge[found], 'bot'), 500);
            } else {
                setTimeout(() => appendMessage(`T√¥i ch∆∞a bi·∫øt v·ªÅ "**${text}**". H√£y d√πng l·ªánh **!HOC ${text} = [C√¢u tr·∫£ l·ªùi]** ƒë·ªÉ d·∫°y t√¥i nh√©!`, 'bot'), 500);
            }
        }
    }

    // S·ª± ki·ªán Enter v√† Kh·ªüi ƒë·ªông
    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });

    function resetChat() {
        if(confirm("X√≥a l·ªãch s·ª≠ v√† c√°c b√†i h·ªçc ƒë√£ h·ªçc?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // Ch·∫°y khi m·ªü trang
    loadMemory();
    loadKnowledge().then(() => {
        appendMessage("üëã Xin ch√†o! Nh·∫≠p **!DANHGON** ho·∫∑c **!JOKE** ƒë·ªÉ test m·∫°ng, ho·∫∑c **!HOC** ƒë·ªÉ d·∫°y t√¥i.", 'bot');
    });

</script>

</body>
</html>