<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot V22.1 - Ti·∫øng Vi·ªát</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f7f6; display: flex; flex-direction: column; height: 100vh; }
        .header { background-color: #007bff; color: white; padding: 15px; text-align: center; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .header button { background-color: #dc3545; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        #chat-window { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; line-height: 1.4; }
        .bot { background-color: #e9ecef; align-self: flex-start; border-bottom-left-radius: 2px; }
        .user { background-color: #007bff; color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        #input-area { padding: 10px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        #user-input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
        #send-btn { padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .error-msg { background-color: #ffebee; color: #c62828; border: 1px solid #ef9a9a; }
    </style>
</head>
<body>

<div class="header">
    ü§ñ Chatbot AI
    <button onclick="taiLaiTrang()">X√≥a L·ªãch S·ª≠</button>
</div>

<div id="chat-window"></div>

<div id="input-area">
    <input type="text" id="user-input" placeholder="Nh·∫≠p tin nh·∫Øn (!HOC, !DANHGON)...">
    <button id="send-btn" onclick="guiTinNhan()">G·ª≠i</button>
</div>

<script>
    let boNho = {}; // ƒê·ªïi t√™n bi·∫øn ki·∫øn th·ª©c th√†nh "boNho"

    // 1. T·∫£i ki·∫øn th·ª©c t·ª´ file knowledge.json
    async function taiBoNhoFile() { // ƒê·ªïi t√™n h√†m th√†nh "taiBoNhoFile"
        try {
            const phanHoi = await fetch('knowledge.json'); // ƒê·ªïi t√™n bi·∫øn
            if (!phanHoi.ok) throw new Error("Khong tim thay file");
            const duLieu = await phanHoi.json(); // ƒê·ªïi t√™n bi·∫øn
            boNho = { ...boNho, ...duLieu };
            console.log("Da tai knowledge.json");
        } catch (loi) { // ƒê·ªïi t√™n bi·∫øn
            hienThiTinNhan(`‚ö†Ô∏è **Luu y:** Khong tai duoc file 'knowledge.json'. Bot se dung kien thuc ban day thu cong.`, 'bot error-msg');
        }
    }

    // 2. T·∫£i ki·∫øn th·ª©c ƒë√£ d·∫°y (Local Storage)
    function taiBoNhoLocal() { // ƒê·ªïi t√™n h√†m
        for (let i = 0; i < localStorage.length; i++) {
            const khoa = localStorage.key(i); // ƒê·ªïi t√™n bi·∫øn
            if (!khoa.startsWith('chat_history')) {
                boNho[khoa] = localStorage.getItem(khoa);
            }
        }
    }

    // 3. Giao di·ªán Chat
    const chatWindow = document.getElementById('chat-window');
    
    function hienThiTinNhan(chuoi, nguoiGui) { // ƒê·ªïi t√™n h√†m
        const div = document.createElement('div');
        div.className = `message ${nguoiGui}`;
        div.innerHTML = chuoi.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // 4. X·ª≠ l√Ω L·ªánh
    async function xuLyLenh(dauVao) { // ƒê·ªïi t√™n h√†m
        const lenhInHoa = dauVao.toUpperCase(); // ƒê·ªïi t√™n bi·∫øn

        // L·ªánh !DANHGON
        if (lenhInHoa === '!DANHGON') {
            hienThiTinNhan("‚è≥ Dang tai danh ngon tu Internet...", 'bot');
            try {
                const res = await fetch('https://dummyjson.com/quotes/random');
                const duLieu = await res.json();
                const danhNgon = duLieu.quote; // Ti·∫øng Anh b·∫Øt bu·ªôc t·ª´ API
                const tacGia = duLieu.author; // Ti·∫øng Anh b·∫Øt bu·ªôc t·ª´ API
                hienThiTinNhan(`üí° **Danh ngon:**\n"${danhNgon}"\n‚Äî *${tacGia}*`, 'bot');
            } catch (loi) {
                hienThiTinNhan(`‚ùå Loi ket noi: ${loi.message}`, 'bot error-msg');
            }
            return true;
        }

        // L·ªánh !HOC
        if (lenhInHoa.startsWith('!HOC')) {
            const mangPhanChia = dauVao.substring(4).split('='); // ƒê·ªïi t√™n bi·∫øn
            if (mangPhanChia.length < 2) {
                hienThiTinNhan("‚ö†Ô∏è Sai cu phap. Dung: !HOC Cau hoi = Cau tra loi", 'bot');
                return true;
            }
            const khoa = mangPhanChia[0].trim().toLowerCase();
            const giaTri = mangPhanChia[1].trim();
            localStorage.setItem(khoa, giaTri);
            boNho[khoa] = giaTri;
            hienThiTinNhan(`‚úÖ Da hoc: **"${khoa}"**`, 'bot');
            return true;
        }

        // L·ªánh !JOKE
        if (lenhInHoa === '!JOKE') {
            hienThiTinNhan(`‚è≥ Dang tim kiem chuyen cuoi...`, 'bot');
            try {
                const phanHoi = await fetch('https://api.chucknorris.io/jokes/random');
                const duLieu = await phanHoi.json();
                const chuyenCuoi = duLieu.value; // Ti·∫øng Anh b·∫Øt bu·ªôc t·ª´ API
                hienThiTinNhan(`üòÇ **Chuyen cuoi:**\n${chuyenCuoi}`, 'bot');
            } catch (loi) {
                hienThiTinNhan(`**‚ö†Ô∏è LOI KET NOI:** Khong the ke chuyen cuoi. (Loi: ${loi.message})`, 'bot');
            }
            return true;
        }

        return false;
    }

    // 5. X·ª≠ l√Ω Tin nh·∫Øn
    async function guiTinNhan() { // ƒê·ªïi t√™n h√†m
        const oNhap = document.getElementById('user-input'); // ƒê·ªïi t√™n bi·∫øn
        const chuoi = oNhap.value.trim();
        if (!chuoi) return;

        hienThiTinNhan(chuoi, 'user');
        oNhap.value = '';

        const laLenh = await xuLyLenh(chuoi); // ƒê·ªïi t√™n bi·∫øn
        if (laLenh) return;

        // Tim kiem cau tra loi
        const khoaHoi = chuoi.toLowerCase(); // ƒê·ªïi t√™n bi·∫øn
        if (boNho[khoaHoi]) {
            setTimeout(() => hienThiTinNhan(boNho[khoaHoi], 'bot'), 500);
        } else {
            // Tim kiem linh hoat
            const timThay = Object.keys(boNho).find(k => khoaHoi.includes(k) || k.includes(khoaHoi)); // ƒê·ªïi t√™n bi·∫øn
            if (timThay && boNho[timThay]) {
                setTimeout(() => hienThiTinNhan(boNho[timThay], 'bot'), 500);
            } else {
                setTimeout(() => hienThiTinNhan(`Toi chua biet ve "**${chuoi}**". Hay dung lenh **!HOC ${chuoi} = [Cau tra loi]** de day toi nhe!`, 'bot'), 500);
            }
        }
    }

    // S·ª± ki·ªán Enter v√† Kh·ªüi ƒë·ªông
    document.getElementById('user-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') guiTinNhan();
    });

    function taiLaiTrang() { // ƒê·ªïi t√™n h√†m
        if(confirm("Xoa lich su va cac bai hoc da hoc?")) {
            localStorage.clear();
            location.reload();
        }
    }

    // Ch·∫°y khi m·ªü trang
    taiBoNhoLocal();
    taiBoNhoFile().then(() => {
        hienThiTinNhan("üëã Xin chao! Nhap **!DANHGON** hoac **!JOKE** de test mang, hoac **!HOC** de day toi.", 'bot');
    });

</script>

</body>
</html>